<div class="container-fluid">
  <!-- En-tête avec statistiques -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h3 class="text-warning">{{ totalEnAttente }}</h3>
          <small>En Attente</small>
          <div class="mt-2">
            <small class="text-muted">{{ formatMontant(montantTotalEnAttente) }}</small>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h3 class="text-success">{{ totalValidees }}</h3>
          <small>Validées</small>
          <div class="mt-2">
            <small class="text-muted">{{ formatMontant(montantTotalValidees) }}</small>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h3 class="text-danger">{{ totalRejetees }}</h3>
          <small>Rejetées</small>
          <div class="mt-2">
            <small class="text-muted">{{ formatMontant(montantTotalRejetees) }}</small>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h3 class="text-primary">{{ totalEnAttente + totalValidees + totalRejetees }}</h3>
          <small>Total Dépenses</small>
          <div class="mt-2">
            <small class="text-muted">{{ formatMontant(montantTotalEnAttente + montantTotalValidees + montantTotalRejetees) }}</small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Alertes -->
  <div class="row mb-3" *ngIf="getAlertes().length > 0">
    <div class="col-12">
      <div *ngFor="let alerte of getAlertes()" class="alert" [ngClass]="'alert-' + alerte.type">
        <i class="bi bi-exclamation-triangle me-2"></i>
        {{ alerte.message }}
      </div>
    </div>
  </div>

  <!-- Actions en masse -->
  <div class="row mb-3">
    <div class="col-md-6">
      <div class="btn-group">
        <button class="btn btn-success" (click)="validerToutesDepenses()" [disabled]="totalEnAttente === 0">
          <i class="bi bi-check-all me-2"></i>Valider Tout
        </button>
        <button class="btn btn-danger" (click)="rejeterToutesDepenses()" [disabled]="totalEnAttente === 0">
          <i class="bi bi-x-all me-2"></i>Rejeter Tout
        </button>
      </div>
    </div>
    <div class="col-md-6">
      <div class="btn-group float-end">
        <button class="btn btn-primary" (click)="genererRapportValidation()">
          <i class="bi bi-file-earmark-text me-2"></i>Rapport
        </button>
        <button class="btn btn-success" (click)="imprimerRapport()">
          <i class="bi bi-printer me-2"></i>Imprimer
        </button>
        <button class="btn btn-info" (click)="exporterPDF()">
          <i class="bi bi-file-earmark-pdf me-2"></i>PDF
        </button>
      </div>
    </div>
  </div>

  <!-- Filtres -->
  <div class="row mb-3">
    <div class="col-md-3">
      <label class="form-label">Statut</label>
      <select class="form-select" [(ngModel)]="statutSelectionne">
        <option value="">Tous</option>
        <option value="en_attente">En attente</option>
        <option value="validee">Validée</option>
        <option value="rejetee">Rejetée</option>
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label">Catégorie</label>
      <select class="form-select" [(ngModel)]="categorieSelectionnee">
        <option value="">Toutes</option>
        <option value="scolarite">Scolarité</option>
        <option value="sante">Santé</option>
        <option value="nutrition">Nutrition</option>
        <option value="transport">Transport</option>
        <option value="administration">Administration</option>
        <option value="autres">Autres</option>
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label">Montant Min</label>
      <input type="number" class="form-control" [(ngModel)]="montantMin" placeholder="0">
    </div>
    <div class="col-md-3">
      <label class="form-label">Montant Max</label>
      <input type="number" class="form-control" [(ngModel)]="montantMax" placeholder="100000">
    </div>
  </div>

  <!-- Tableau des dépenses -->
  <div class="card">
    <div class="card-header">
      <h6 class="mb-0">Validation des Dépenses</h6>
    </div>
    <div class="card-body p-0">
      <table class="table table-striped mb-0">
        <thead>
          <tr>
            <th>Description</th>
            <th>Catégorie</th>
            <th>Montant</th>
            <th>Date</th>
            <th>Statut</th>
            <th>Justificatif</th>
            <th>Validé par</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let depense of filtrerDepenses()" [ngClass]="{
            'table-warning': depense.statut === 'en_attente',
            'table-success': depense.statut === 'validee',
            'table-danger': depense.statut === 'rejetee'
          }">
            <td><strong>{{ depense.description }}</strong></td>
            <td>
              <span [ngClass]="getCategorieClass(depense.categorie)">
                {{ depense.categorie | titlecase }}
              </span>
            </td>
            <td>{{ formatMontant(depense.montant) }}</td>
            <td>{{ depense.dateDepense | date:'dd/MM/yyyy' }}</td>
            <td>
              <span class="badge" [ngClass]="getStatutClass(depense.statut)">
                {{ depense.statut | titlecase }}
              </span>
            </td>
            <td>
              <i [class]="getJustificatifIcon(depense)"></i>
              {{ getJustificatifText(depense) }}
            </td>
            <td>
              <span *ngIf="depense.validePar">{{ depense.validePar }}</span>
              <span *ngIf="!depense.validePar" class="text-muted">-</span>
            </td>
            <td>
              <div class="btn-group btn-group-sm">
                <button *ngIf="depense.statut === 'en_attente'" 
                        class="btn btn-outline-success" 
                        (click)="validerDepense(depense)"
                        title="Valider">
                  <i class="bi bi-check"></i>
                </button>
                <button *ngIf="depense.statut === 'en_attente'" 
                        class="btn btn-outline-danger" 
                        (click)="rejeterDepense(depense)"
                        title="Rejeter">
                  <i class="bi bi-x"></i>
                </button>
                <button *ngIf="depense.statut === 'rejetee'" 
                        class="btn btn-outline-info" 
                        title="Motif de rejet"
                        (click)="showMotifRejet(depense)">
                  <i class="bi bi-info-circle"></i>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Détails des dépenses rejetées -->
  <div class="row mt-4" *ngIf="depensesRejetees.length > 0">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h6 class="mb-0">Dépenses Rejetées - Détails</h6>
        </div>
        <div class="card-body p-0">
          <table class="table table-sm mb-0">
            <thead>
              <tr>
                <th>Description</th>
                <th>Montant</th>
                <th>Motif de Rejet</th>
                <th>Date de Rejet</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let depense of depensesRejetees" class="table-danger">
                <td>{{ depense.description }}</td>
                <td>{{ formatMontant(depense.montant) }}</td>
                <td>{{ depense.motifRejet || 'Aucun motif spécifié' }}</td>
                <td>{{ depense.dateValidation | date:'dd/MM/yyyy' }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Graphiques (simulation) -->
  <div class="row mt-4">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h6 class="mb-0">Répartition par Statut</h6>
        </div>
        <div class="card-body">
          <div class="d-flex justify-content-between mb-2">
            <span>En attente</span>
            <span class="badge bg-warning">{{ totalEnAttente }}</span>
          </div>
          <div class="progress mb-3">
            <div class="progress-bar bg-warning" 
                 [style.width.%]="getPourcentageStatut('en_attente')"></div>
          </div>
          
          <div class="d-flex justify-content-between mb-2">
            <span>Validées</span>
            <span class="badge bg-success">{{ totalValidees }}</span>
          </div>
          <div class="progress mb-3">
            <div class="progress-bar bg-success" 
                 [style.width.%]="getPourcentageStatut('validee')"></div>
          </div>
          
          <div class="d-flex justify-content-between mb-2">
            <span>Rejetées</span>
            <span class="badge bg-danger">{{ totalRejetees }}</span>
          </div>
          <div class="progress">
            <div class="progress-bar bg-danger" 
                 [style.width.%]="getPourcentageStatut('rejetee')"></div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h6 class="mb-0">Répartition par Montant</h6>
        </div>
        <div class="card-body">
          <div class="d-flex justify-content-between mb-2">
            <span>En attente</span>
            <span class="text-warning">{{ formatMontant(montantTotalEnAttente) }}</span>
          </div>
          <div class="progress mb-3">
            <div class="progress-bar bg-warning" 
                 [style.width.%]="getPourcentageMontant('en_attente')"></div>
          </div>
          
          <div class="d-flex justify-content-between mb-2">
            <span>Validées</span>
            <span class="text-success">{{ formatMontant(montantTotalValidees) }}</span>
          </div>
          <div class="progress mb-3">
            <div class="progress-bar bg-success" 
                 [style.width.%]="getPourcentageMontant('validee')"></div>
          </div>
          
          <div class="d-flex justify-content-between mb-2">
            <span>Rejetées</span>
            <span class="text-danger">{{ formatMontant(montantTotalRejetees) }}</span>
          </div>
          <div class="progress">
            <div class="progress-bar bg-danger" 
                 [style.width.%]="getPourcentageMontant('rejetee')"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de rejet -->
<div class="modal fade" [class.show]="showRejetForm" [style.display]="showRejetForm ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Rejeter la Dépense</h5>
        <button type="button" class="btn-close" (click)="annulerRejet()"></button>
      </div>
      <div class="modal-body">
        <div *ngIf="depenseSelectionnee" class="mb-3">
          <strong>Dépense :</strong> {{ depenseSelectionnee.description }}<br>
          <strong>Montant :</strong> {{ formatMontant(depenseSelectionnee.montant) }}<br>
          <strong>Catégorie :</strong> {{ depenseSelectionnee.categorie | titlecase }}
        </div>
        <div class="mb-3">
          <label class="form-label">Motif de rejet *</label>
          <textarea class="form-control" 
                    [(ngModel)]="motifRejet" 
                    rows="3" 
                    placeholder="Veuillez saisir le motif de rejet..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="annulerRejet()">Annuler</button>
        <button type="button" class="btn btn-danger" (click)="confirmerRejet()">Confirmer le Rejet</button>
      </div>
    </div>
  </div>
</div>

<!-- Overlay pour le modal -->
<div class="modal-backdrop fade show" *ngIf="showRejetForm"></div>
